# V11 可视化问题排查指南

## 问题：Web页面显示损坏的图像

如果访问 `http://127.0.0.1:8082` 时看到损坏的图像图标，请按照以下步骤排查：

### 1. 检查数据是否已添加

可视化图表需要至少1个数据点才能显示。请检查：

- 终端输出中是否有 `📊 第 X 轮预测` 的日志
- 是否有 `可视化更新失败` 的错误信息

### 2. 等待几轮循环

**第一次运行**：
- 系统需要完成第一轮预测后才会添加数据点
- 等待约5-10分钟（取决于数据获取速度）
- 然后刷新浏览器页面（F5）

### 3. 检查浏览器控制台

1. 按 `F12` 打开浏览器开发者工具
2. 切换到 `Console`（控制台）标签
3. 查看是否有JavaScript错误
4. 切换到 `Network`（网络）标签
5. 查看 `/plot/price`、`/plot/indicators`、`/plot/dashboard` 请求：
   - 状态码应该是 `200`
   - 响应类型应该是 `image/png`
   - 如果有错误（如404、500），会在状态码中显示

### 4. 检查图像URL

确保图像URL正确：
- `http://127.0.0.1:8082/plot/price`
- `http://127.0.0.1:8082/plot/indicators`
- `http://127.0.0.1:8082/plot/dashboard`

直接在浏览器地址栏访问这些URL，应该能看到图像。

### 5. 查看输出目录

检查 `visualization_output` 目录：

```bash
# Windows PowerShell
dir visualization_output

# 应该看到类似的文件：
# - dashboard.png
# - price_chart_YYYYMMDD_HHMMSS.png
# - data.csv
```

### 6. 常见问题

#### 问题1：图表一直显示"等待数据中..."

**原因**：数据点还没有被添加

**解决**：
- 等待系统完成至少一轮预测
- 检查终端是否有数据获取成功的日志
- 确保股票代码和数据源可用

#### 问题2：图表显示为损坏的图像

**原因**：图像生成或传输失败

**解决**：
1. 刷新浏览器页面（F5）
2. 检查终端是否有错误信息
3. 直接访问图像URL测试
4. 重启V11系统

#### 问题3：端口被占用

**错误信息**：`⚠️ Web服务器启动可能失败，请检查端口 8082 是否被占用`

**解决**：
1. 检查是否有其他进程占用8082端口
2. 或者在V11代码中修改端口号：
   ```python
   VISUALIZATION_PORT = 8083  # 改为其他端口
   ```

### 7. 手动测试

#### 测试图像生成

在Python交互环境中测试：

```python
from ZCF_RL_STOCK.realtime_visualization import RealTimeVisualizer

visualizer = RealTimeVisualizer()

# 添加测试数据
visualizer.add_data_point(price=12.61, volume=1000)

# 生成图表
img_bytes = visualizer.plot_price_chart()
print(f"图像字节数: {len(img_bytes) if img_bytes else 0}")

# 保存测试
visualizer.plot_price_chart(save_path='test_price.png')
print("图表已保存到 test_price.png")
```

#### 测试Web服务器

```python
from ZCF_RL_STOCK.realtime_visualization import RealTimeVisualizer, WebVisualizationServer

visualizer = RealTimeVisualizer()
visualizer.add_data_point(price=12.61, volume=1000)

server = WebVisualizationServer(visualizer, port=8082)
server.start()

# 等待启动
import time
time.sleep(2)

# 在浏览器访问 http://127.0.0.1:8082
```

### 8. 调试模式

如果问题仍然存在，可以启用详细日志：

在 `real_time_predict_v11.py` 中添加：

```python
# 在可视化更新部分添加调试信息
if visualizer:
    try:
        # ... 现有代码 ...
        visualizer.add_data_point(...)
        
        # 添加调试信息
        print(f"   📊 可视化数据点数: 价格={len(visualizer.price_history)}, "
              f"成交量={len(visualizer.volume_history)}, "
              f"指标={len(visualizer.indicators_history)}")
    except Exception as e:
        print(f"   ❌ 可视化更新失败: {e}")
        import traceback
        traceback.print_exc()
```

### 9. 快速修复

如果所有方法都无效，尝试：

1. **重启系统**：按 `Ctrl+C` 停止，然后重新运行
2. **清除缓存**：删除 `visualization_output` 目录下的所有文件
3. **检查依赖**：确保 `matplotlib` 和 `flask` 已正确安装
   ```bash
   pip install matplotlib flask --upgrade
   ```

### 10. 预期行为

**正常情况**：
- 第一轮预测完成后，应该能看到价格图
- 如果有技术指标数据，会显示指标图
- 综合仪表板会显示所有数据

**数据更新**：
- 图表每5秒自动刷新一次（由HTML中的`<meta http-equiv="refresh" content="5">`控制）
- 也可以手动按 `F5` 刷新

---

**如果问题仍然存在，请提供以下信息**：
1. 终端输出的完整错误信息
2. 浏览器控制台的错误信息
3. 系统运行了多少轮预测
4. `visualization_output` 目录的内容


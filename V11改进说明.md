# V11 系统改进说明

## 📋 改进概览

本次更新实现了4个核心改进，显著提升了预测准确性和系统智能化水平。

---

## 🎯 改进1：滑动窗口归一化

### 问题
- **全局归一化问题**：使用全部历史数据归一化会导致预测偏低
- **原因**：历史数据包含很久以前的极值，归一化范围过大

### 解决方案
- **滑动窗口归一化**：只使用最近N个数据点进行归一化
- **配置参数**：
  ```python
  USE_SLIDING_WINDOW_NORMALIZE = True  # 启用滑动窗口
  SLIDING_WINDOW_SIZE = 500  # 窗口大小（最近500个数据点）
  ```

### 效果
- ✅ 避免预测价格偏低
- ✅ 更准确地反映当前市场状态
- ✅ 适用于LSTM和Transformer模型

### 使用说明
- 如果数据点 > 500，自动使用滑动窗口
- 否则使用全局归一化（数据较少时）

---

## 🎯 改进2：融合权重动态调整

### 问题
- **固定权重问题**：模型权重固定，无法根据表现调整
- **表现差异**：不同模型在不同市场环境下表现不同

### 解决方案
- **动态权重调整**：根据模型历史表现自动调整权重
- **表现评估**：记录每个模型的预测误差历史
- **权重调整**：表现好的模型权重增加，表现差的权重减少

### 配置参数
```python
ENABLE_DYNAMIC_WEIGHTS = True  # 启用动态权重
WEIGHT_ADAPTATION_RATE = 0.1  # 调整速率
WEIGHT_MIN = 0.05  # 最小权重
WEIGHT_MAX = 0.6  # 最大权重
```

### 算法逻辑
1. 记录每个模型的预测误差
2. 计算平均误差和表现分数
3. 根据表现分数调整权重
4. 归一化权重，确保总和为1

### 效果
- ✅ 自动适应市场变化
- ✅ 提升表现好的模型权重
- ✅ 降低表现差的模型权重

---

## 🎯 改进3：多模态处理使用真实新闻源

### 问题
- **固定样本问题**：使用固定的样本文本，缺乏实时性
- **情感分析不准确**：无法反映真实市场情绪

### 解决方案
- **真实新闻源**：从LLM市场情报代理获取实时新闻
- **回退机制**：如果获取失败，回退到样本文本

### 配置参数
```python
USE_REAL_NEWS_SOURCE = True  # 使用真实新闻源
FALLBACK_TO_SAMPLE_TEXTS = True  # 失败时回退
```

### 工作流程
1. 尝试从LLM市场情报代理获取当日新闻
2. 如果成功，使用真实新闻进行情感分析
3. 如果失败，回退到样本文本

### 效果
- ✅ 使用真实市场新闻
- ✅ 情感分析更准确
- ✅ 多模态处理更有价值

---

## 🎯 改进4：量化回测功能

### 功能说明
- **实时回测**：在运行过程中实时计算预测指标
- **多指标评估**：计算MAE、RMSE、MAPE、方向准确率

### 回测指标

#### 1. MAE (Mean Absolute Error) - 平均绝对误差
```python
MAE = np.mean(np.abs(predictions - actuals))
```
- **含义**：预测值与实际值的平均绝对差异
- **越小越好**：表示预测越准确

#### 2. RMSE (Root Mean Squared Error) - 均方根误差
```python
RMSE = np.sqrt(np.mean((predictions - actuals)**2))
```
- **含义**：预测误差的平方根
- **越小越好**：对大误差更敏感

#### 3. MAPE (Mean Absolute Percentage Error) - 平均绝对百分比误差
```python
MAPE = np.mean(np.abs((predictions - actuals) / actuals)) * 100
```
- **含义**：预测误差的百分比
- **越小越好**：便于理解误差大小

#### 4. Direction Accuracy - 方向准确率
```python
pred_directions = np.sign(np.diff(predictions))
actual_directions = np.sign(np.diff(actuals))
direction_accuracy = np.mean(pred_directions == actual_directions) * 100
```
- **含义**：预测方向（涨/跌）的准确率
- **越高越好**：表示能正确预测趋势方向

### 配置参数
```python
ENABLE_BACKTEST = True  # 启用回测
BACKTEST_METRICS = ['MAE', 'RMSE', 'MAPE', 'Direction_Accuracy']
```

### 输出说明
- 每10轮输出一次回测指标
- 显示最近20次的平均表现
- 帮助评估模型预测质量

### 效果
- ✅ 实时评估预测准确性
- ✅ 多维度指标评估
- ✅ 帮助优化模型参数

---

## 📊 使用建议

### 1. 滑动窗口归一化
- **推荐设置**：`SLIDING_WINDOW_SIZE = 500`
- **调整建议**：根据数据频率调整（5分钟数据用500，日线数据用200）

### 2. 动态权重调整
- **推荐启用**：`ENABLE_DYNAMIC_WEIGHTS = True`
- **调整建议**：`WEIGHT_ADAPTATION_RATE = 0.1`（保守）或 `0.2`（激进）

### 3. 真实新闻源
- **推荐启用**：`USE_REAL_NEWS_SOURCE = True`
- **注意**：需要LLM市场情报代理正常工作

### 4. 量化回测
- **推荐启用**：`ENABLE_BACKTEST = True`
- **监控频率**：每10轮输出一次（可调整）

---

## 🔧 配置示例

```python
# V11改进配置
USE_SLIDING_WINDOW_NORMALIZE = True
SLIDING_WINDOW_SIZE = 500

ENABLE_DYNAMIC_WEIGHTS = True
WEIGHT_ADAPTATION_RATE = 0.1
WEIGHT_MIN = 0.05
WEIGHT_MAX = 0.6

USE_REAL_NEWS_SOURCE = True
FALLBACK_TO_SAMPLE_TEXTS = True

ENABLE_BACKTEST = True
BACKTEST_METRICS = ['MAE', 'RMSE', 'MAPE', 'Direction_Accuracy']
```

---

## 📈 预期效果

1. **预测准确性提升**：滑动窗口归一化避免预测偏低
2. **自适应能力增强**：动态权重自动适应市场变化
3. **情感分析更准确**：真实新闻源提供更准确的市场情绪
4. **可评估性提升**：量化回测提供客观的评估指标

---

## ⚠️ 注意事项

1. **滑动窗口大小**：需要根据数据频率调整
2. **动态权重**：需要一定历史数据才能生效（至少10次预测）
3. **真实新闻源**：依赖LLM市场情报代理，可能产生API调用费用
4. **回测指标**：需要至少2次预测才能计算

---

## 🎉 总结

V11改进版本通过滑动窗口归一化、动态权重调整、真实新闻源和量化回测，显著提升了系统的预测准确性和智能化水平。建议启用所有改进功能以获得最佳效果。


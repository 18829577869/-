# V4 Final - 深度强化学习股票交易系统（终极优化版）

## 🎯 版本亮点

基于对之前版本的全面评估，V4 Final 进行了以下**核心优化**：

### 1. **观测空间升级** 🔭
- ✅ **历史窗口**：从单时刻到过去5天数据，智能体可以感知趋势
- ✅ **技术指标**：增加 MA5/MA20/RSI/MACD/成交量比，提升特征维度
- ✅ **持仓信息**：包含持仓比例、现金比例、当前收益率、当前回撤
- **观测维度**：5天×18特征 + 4维持仓信息 = **94维**

### 2. **奖励函数优化** 🎁
采用**多目标平衡设计**：
```python
奖励 = 日收益率奖励 + 回撤惩罚 + 交易成本惩罚 + 稳定盈利奖励
```
- 渐进式回撤惩罚（10%/20%/30%分档）
- 鼓励减少频繁交易
- 对稳定盈利给予额外奖励

### 3. **评估体系完善** 📊
新增关键指标：
- **夏普比率**：风险调整后收益
- **最大回撤**：风险控制能力
- **胜率**：交易胜率统计
- **与基准对比**：相对买入持有策略的表现

### 4. **训练策略改进** 🚀
- 训练步数：150万 → **300万步**
- 并行环境：8个 → **16个**
- 增加熵系数（`ent_coef=0.01`）鼓励探索
- 检查点保存：每10万步自动保存
- 评估回调：每5万步评估并保存最佳模型

### 5. **保留V4优点** ✨
- ✅ 真实交易成本（手续费、印花税、过户费）
- ✅ 滑点模拟
- ✅ 最小交易单位限制（100股整数倍）
- ✅ 防爆仓机制（亏损50%强制停止）

---

## 📦 安装依赖

```bash
pip install stable-baselines3 gymnasium pandas numpy matplotlib baostock
```

---

## 🚀 快速开始

### 1️⃣ 下载数据
```bash
python get_stock_data_v3.py
```

### 2️⃣ 训练模型
```bash
python train_v4_final.py
```

训练过程：
- 自动使用所有可用的训练数据（train目录）
- 每10万步保存检查点到 `models_v4_final/`
- 训练日志保存到 `logs_v4_final/`（可用TensorBoard查看）
- 训练完成后自动在测试集上回测

### 3️⃣ 详细评估（单只股票）
```bash
python evaluate_v4_final.py --model ppo_stock_v4_final.zip --data stockdata/test/sh.600036.招商银行.csv
```

生成内容：
- 📊 详细的评估报告（收益、风险、交易统计）
- 📈 可视化图表（净值曲线、回撤曲线、收益分布）
- 💾 图表保存为 `evaluation_result.png`

### 4️⃣ 模型对比
```bash
python compare_models.py
```

自动对比 V3 Final、V4、V4 Final 三个版本的性能，生成对比图表。

---

## 📊 评估指标说明

### 收益指标
- **总收益率**：(最终净值 - 初始资金) / 初始资金 × 100%
- **买入持有收益**：同期简单买入持有策略的收益
- **超额收益**：策略收益 - 买入持有收益

### 风险指标
- **最大回撤**：从最高点到最低点的最大跌幅
- **夏普比率**：(年化收益率 - 无风险利率) / 年化波动率
  - \> 2：优秀 ⭐⭐⭐⭐⭐
  - \> 1：良好 ⭐⭐⭐⭐
  - \> 0：一般 ⭐⭐⭐
  - < 0：较差 ⭐⭐

### 交易统计
- **交易次数**：买入+卖出的总次数
- **胜率**：盈利天数 / 总交易天数 × 100%
- **动作分布**：买入/卖出/持有的比例

---

## 🔧 技术架构

### 环境设计（`stock_env_v4_final.py`）

```
观测空间（94维）:
├─ 历史窗口（5天 × 18特征 = 90维）
│  ├─ 基础数据：open, high, low, close, preclose, volume, amount, turn, pctChg
│  ├─ 估值指标：peTTM, psTTM, pcfNcfTTM, pbMRQ
│  └─ 技术指标：MA5, MA20, RSI, MACD, Volume_Ratio
└─ 持仓信息（4维）
   ├─ 持仓比例
   ├─ 现金比例
   ├─ 当前收益率
   └─ 当前回撤

动作空间（2维连续）:
├─ action_type: [0, 2]  (0=卖出, 1=持有, 2=买入)
└─ amount: [0, 1]       (操作仓位比例)

奖励函数:
reward = 日收益率×100 + 回撤惩罚 + 交易成本惩罚 + 稳定盈利奖励
```

### 算法选择
- **算法**：PPO (Proximal Policy Optimization)
- **策略网络**：MlpPolicy（多层感知机）
- **超参数**：
  - `learning_rate=3e-4`：学习率
  - `gamma=0.99`：折扣因子
  - `ent_coef=0.01`：熵系数（鼓励探索）
  - `clip_range=0.2`：PPO裁剪范围

---

## 📈 性能对比

| 指标 | V3 Final | V4 | **V4 Final** |
|------|----------|-------|--------------|
| 观测维度 | 13 | 13 | **94** ✨ |
| 历史窗口 | ❌ | ❌ | **✅ 5天** |
| 技术指标 | ❌ | ❌ | **✅ 5个** |
| 持仓信息 | ❌ | ❌ | **✅ 4维** |
| 交易成本 | ❌ | ✅ | **✅** |
| 回撤控制 | ✅ 强 | ⚠️ 弱 | **✅ 强** |
| 奖励设计 | 分段惩罚 | 简单归一化 | **多目标平衡** |
| 训练步数 | 150万 | 200万 | **300万** |
| 评估指标 | 基础 | 基础 | **完善** ✨ |

---

## 💡 使用建议

### 实盘前必做
1. ✅ **扩充训练数据**：至少30-50只股票，覆盖不同行业
2. ✅ **延长回测周期**：测试多个市场周期（牛市、熊市、震荡市）
3. ✅ **模拟交易**：先用模拟盘运行1-3个月
4. ✅ **风控设置**：设置止损线、单日最大亏损等
5. ✅ **定期重训**：每月用最新数据微调模型

### 参数调优建议
- **激进策略**：降低回撤惩罚，提高收益奖励权重
- **保守策略**：增加回撤惩罚，降低交易频率
- **不同市场**：牛市可提高持仓比例，熊市增加现金仓位

### 常见问题

**Q: 为什么训练很慢？**  
A: 300万步训练需要较长时间（取决于CPU性能）。建议：
- 减少并行环境数量（16→8）
- 使用更少的训练股票
- 在GPU上训练（需安装 `stable-baselines3[extra]`）

**Q: 模型在测试集表现不好？**  
A: 可能的原因：
- 训练数据太少（过拟合）
- 市场环境变化（需重训）
- 超参数不适合当前股票

**Q: 如何提升收益？**  
A: 建议：
- 增加更多技术指标（布林带、KDJ等）
- 使用LSTM捕捉长期依赖
- 尝试其他算法（SAC、TD3）

---

## 📚 进一步优化方向

### 短期（1-2周）
- [ ] 增加更多技术指标（布林带、KDJ、OBV等）
- [ ] 实现多股票组合管理
- [ ] 增加市场环境特征（大盘指数、行业指数）

### 中期（1个月）
- [ ] 使用LSTM/GRU处理时序信息
- [ ] 实现注意力机制，自动学习特征权重
- [ ] 增加宏观经济指标（利率、GDP、CPI等）

### 长期（3个月+）
- [ ] 使用Transformer架构
- [ ] 多智能体协同（激进+保守组合）
- [ ] 在线学习，实时适应市场变化
- [ ] 接入实盘API，全自动交易

---

## 📝 版本历史

- **V1**：基础版本，简单环境
- **V2**：增加更多特征
- **V3**：增加回撤控制
- **V3 Final**：强化防大亏机制
- **V4**：增加真实交易成本
- **V4 Final**（当前）：全面优化（特征+奖励+评估）

---

## 📄 文件说明

```
RL-Stock/
├── stock_env_v4_final.py      # 核心环境（优化版）
├── train_v4_final.py          # 训练脚本
├── evaluate_v4_final.py       # 详细评估脚本
├── compare_models.py          # 多版本对比脚本
├── get_stock_data_v3.py       # 数据下载脚本
├── models_v4_final/           # 模型检查点目录
├── logs_v4_final/             # 训练日志目录
└── stockdata/                 # 数据目录
    ├── train/                 # 训练数据
    └── test/                  # 测试数据
```

---

## ⚠️ 免责声明

本项目仅供学习和研究使用，不构成任何投资建议。股市有风险，投资需谨慎。使用本项目进行实盘交易的任何损失，作者不承担任何责任。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📧 联系方式

如有问题，请提交 Issue 或联系项目维护者。

---

**祝你训练顺利，收益长虹！** 📈🚀




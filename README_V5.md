# V5 风险感知增强版

## 🎯 版本目标

**核心改进**：从"被动应对"到"主动感知风险"

V5在V4 Fixed的基础上，重点提升模型的**风险感知和应对能力**。

---

## 🆕 V5 新增功能

### 1. **6个风险指标** 📊

| 指标 | 含义 | 风险信号 |
|------|------|---------|
| **Volatility** | 波动率 | >90分位数 → 市场不稳定 |
| **Volume_Anomaly** | 成交量异常 | >2倍均量 → 可能变盘 |
| **Consecutive_Down** | 连续下跌天数 | ≥3天 → 下跌趋势 |
| **Amplitude** | 日内振幅 | 大幅波动 → 风险增加 |
| **Gap** | 跳空缺口 | >3% → 重大消息 |
| **ATR** | 真实波动幅度 | >85分位数 → 波动放大 |

### 2. **风险等级评估** 🚨

```
风险等级 0-6 分：
- 0-1分：低风险（正常市场）
- 2-3分：中风险（谨慎操作）
- 4-6分：高风险（避免买入）
```

**触发机制**：
- 每个风险信号 +1分
- 实时评估当前风险状况

### 3. **动态风险策略** 🛡️

#### 高风险时（≥3分）：
- ✅ **自动限制买入**（强制改为持有）
- ✅ **鼓励减仓**（卖出操作 +0.3奖励）
- ✅ **空仓奖励**（持有现金 +0.1）
- ✅ **高仓位惩罚**（>50%仓位 -0.2）

#### 低风险时（<3分）：
- ✅ **鼓励持仓**（>50%仓位 +0.1）
- ✅ **空仓惩罚**（持有现金 -0.1）
- ✅ **正常交易奖励**

### 4. **风险应对奖励** 💰

```python
if 风险等级 >= 3:
    if 卖出操作:
        奖励 +0.3  # 高风险时卖出，好！
    if 买入操作:
        奖励 -0.3  # 高风险时买入，差！
```

**学习目标**：让模型学会"高风险时降低仓位"

---

## 📊 特征空间对比

| 版本 | 基础特征 | 技术指标 | 风险指标 | 持仓信息 | 总维度 |
|------|---------|---------|---------|---------|--------|
| V4 Fixed | 13 | 5 | 0 | 4 | 94 |
| **V5** | 13 | 5 | **6** ⭐ | 4+1风险等级 | **125** |

**新增维度**：
- 历史窗口：5天 × (13基础 + 5技术 + **6风险**) = 120维
- 当前信息：4维持仓 + **1维风险等级** = 5维
- **总计：125维**

---

## 🚀 使用方法

### 快速开始

```bash
# 1. 训练V5模型
python train_v5.py

# 2. 对比V4 Fixed和V5的效果
python compare_v4_v5.py

# 3. 查看训练曲线
tensorboard --logdir=./logs_v5/
```

### 详细评估

```bash
# 评估单只股票
python evaluate_v5.py --model ppo_stock_v5.zip --data stockdata/test/sh.600036.招商银行.csv
```

---

## 💡 核心改进逻辑

### V4 Fixed的问题

```
市场情况: 突然大跌
V4 Fixed: 继续持仓 → 损失扩大
原因: 无法感知风险变化
```

### V5的解决方案

```
市场情况: 连续下跌3天 + 巨量成交 + 高波动
↓
风险评估: 风险等级 = 3分（高风险）
↓
策略调整: 
  - 如果有持仓 → 卖出操作奖励 +0.3
  - 禁止买入操作
  - 鼓励空仓观望
↓
结果: 及时止损，保护本金
```

---

## 📈 预期效果

### 风险控制

| 指标 | V4 Fixed | V5（预期） |
|------|----------|-----------|
| 最大回撤 | 15-20% | **10-15%** ⬇️ |
| 风险事件应对 | 被动 | **主动** ⬆️ |
| 大跌时反应 | 迟缓 | **快速** ⬆️ |

### 收益表现

```
预期：
- 平稳市场：与V4 Fixed相当
- 波动市场：更好的风险控制
- 大跌市场：损失更小
```

**trade-off**（权衡）：
- ✅ 风险控制更好
- ⚠️ 可能错过部分上涨机会（过度谨慎）

---

## 🔍 风险指标详解

### 1. Volatility（波动率）
```python
计算: 20日收益率标准差 × 100
含义: 价格波动程度
风险: >90分位数时市场不稳定
```

### 2. Volume_Anomaly（成交量异常）
```python
计算: 当日成交量 / 20日均量
含义: 放量/缩量
风险: >2倍均量可能变盘
```

### 3. Consecutive_Down（连续下跌）
```python
计算: 过去5天下跌天数
含义: 下跌趋势强度
风险: ≥3天形成下跌趋势
```

### 4. Amplitude（振幅）
```python
计算: (最高 - 最低) / 收盘 × 100
含义: 日内波动幅度
风险: 振幅过大表示不稳定
```

### 5. Gap（跳空缺口）
```python
计算: (今开 - 昨收) / 昨收 × 100
含义: 隔夜跳空幅度
风险: >3%可能有重大消息
```

### 6. ATR（真实波动幅度）
```python
计算: 14日真实波幅均值 / 价格
含义: 综合波动度量
风险: >85分位数波动放大
```

---

## ⚙️ 参数调整

### 如果觉得太保守

```python
# 在 stock_env_v5.py 中调整

# 1. 提高风险阈值
if risk_level >= 4:  # 从3改为4，更不容易触发
    ...

# 2. 降低风险惩罚
if position_ratio > 0.5:
    position_bonus = -0.1  # 从-0.2改为-0.1

# 3. 增加风险应对奖励
risk_response_bonus = 0.2  # 从0.3改为0.2
```

### 如果觉得不够激进

```python
# 降低风险阈值
if risk_level >= 2:  # 更容易触发风险规避

# 增加风险惩罚
position_bonus = -0.3  # 更重的惩罚
```

---

## 🔬 实验建议

### 对比实验

**A组**：V4 Fixed（无风险感知）  
**B组**：V5（有风险感知）

**对比指标**：
1. 平稳期收益对比
2. 波动期回撤对比
3. 突发事件应对对比

### 训练策略

1. **先训练200万步**（约2小时）
2. **回测验证效果**
3. **如果效果好，继续训练到300-500万步**

---

## ⚠️ 注意事项

### 1. 风险指标的局限性

```
风险指标 ≠ 预测未来
风险指标 = 识别当前异常状况
```

**能做到的**：
- ✅ 识别波动异常
- ✅ 识别趋势变化
- ✅ 快速应对风险

**做不到的**：
- ❌ 提前预知大跌
- ❌ 完美择时
- ❌ 零回撤

### 2. 过度保守的风险

如果风险阈值设置太低，可能导致：
- 频繁空仓
- 错过上涨机会
- 收益率偏低

**建议**：根据回测结果调整参数

### 3. 训练数据的重要性

- 训练数据应包含多种市场情况（牛市、熊市、震荡市）
- 至少30-50只股票
- 时间跨度至少3-5年

---

## 📚 进阶优化方向

### 短期（可立即实施）

1. **调整风险权重**
   - 不同风险指标设置不同权重
   - 波动率和连续下跌权重更高

2. **增加风险分级**
   - 低风险：正常操作
   - 中风险：谨慎操作
   - 高风险：防守操作
   - 极高风险：强制清仓

3. **动态仓位管理**
```python
最大仓位 = 1.0 - (risk_level * 0.15)
# 风险0分：100%仓位
# 风险3分：55%仓位
# 风险6分：10%仓位
```

### 中期（需要开发）

1. **宏观风险指标**
   - 接入市场整体情绪（恐慌指数）
   - 板块轮动情况
   - 资金流向数据

2. **自适应风险阈值**
   - 根据市场环境动态调整
   - 牛市提高阈值，熊市降低阈值

3. **多时间周期风险**
   - 日线风险
   - 周线趋势
   - 月线大势

---

## 🎯 成功标准

### 训练成功的标志

```
1. 评估奖励 > 0（不再是0）
2. 交易次数 > 0
3. 风险事件次数 > 0（说明检测到了风险）
4. 高风险时仓位降低
```

### 实战验证

```
在2024-2025年数据上测试：
- 2024年1-6月（相对平稳）
- 2024年7-12月（有波动）
- 2025年1-3月（测试期）

对比：
- V4 Fixed最大回撤 vs V5最大回撤
- V4 Fixed收益 vs V5收益
```

---

## 📞 使用建议

### 1. 先训练V4 Fixed

```bash
python train_v4_final_fixed.py
```

确保基础交易逻辑正常

### 2. 再训练V5

```bash
python train_v5.py
```

增加风险感知能力

### 3. 对比效果

```bash
python compare_v4_v5.py
```

看哪个版本更适合你的需求

### 4. 根据结果选择

- **追求稳健**：选V5（更好的风控）
- **追求收益**：选V4 Fixed（可能收益更高但波动大）
- **平衡策略**：两者组合使用

---

## 🎉 总结

**V5的核心价值**：

```
让模型从"事后反应"变为"事中感知"

虽然不能预测未来，
但能更快地识别风险，
更及时地做出应对。
```

**适合场景**：
- ✅ 风险厌恶型投资者
- ✅ 波动较大的市场
- ✅ 需要控制回撤的场景

**不适合场景**：
- ❌ 追求极致收益
- ❌ 愿意承受大回撤
- ❌ 超短期交易（日内）

---

**现在就开始训练V5吧！** 🚀

```bash
python train_v5.py
```

预计训练时间：2-3小时（200万步）

祝训练顺利！📈💪




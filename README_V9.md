# V9 混合策略版 - 设计文档

## 🎯 设计理念

**V9 = V7技术指标策略（90%） + LLM实时事件检测（10%）**

### 核心思想

基于实验结果分析：
- ✅ **V7技术指标策略**表现最佳（+10.57%）
- ❌ **V8历史LLM数据**效果最差（+5.98%）
- 💡 **关键洞察**：LLM无法准确"猜测"历史，但能处理实时事件

因此，V9采用**主辅策略结合**：
1. **主策略（95%）**：V7的技术指标 + 差异化风险管理
2. **辅助策略（5%）**：LLM仅在检测到重大事件时介入

---

## 📊 架构设计

### 1. 观测空间

```
V9观测 = V7技术特征 + LLM事件信号
```

#### V7技术特征（主要）
- 历史价格窗口（5天）
- 技术指标：MA5, MA20, RSI, MACD, Volume_Ratio
- 风险指标：Volatility, Volume_Anomaly, Consecutive_Down, Amplitude, Gap, ATR
- 持仓信息：position%, cash%, profit%, drawdown
- 风险等级：0-6级评分
- 标的类别：bank/insurance/liquor/other

#### LLM事件信号（辅助，仅3个关键指标）
- `emergency_impact_score`：突发事件影响（-1到+1）
- `policy_impact_score`：政策影响（-1到+1）
- `risk_level`：市场风险等级（0到1）

### 2. 动作空间

**7个离散动作**（继承V7）：
- 0: 持有
- 1: 买入25%
- 2: 买入50%
- 3: 买入100%
- 4: 卖出25%
- 5: 卖出50%
- 6: 卖出100%

### 3. 奖励函数

```python
reward_v9 = (
    V7_base_reward +           # 净值变化、持仓、交易
    V7_risk_management +       # 回撤惩罚
    LLM_event_adjustment       # 事件调整（权重5%）
)
```

#### LLM事件调整逻辑

**触发条件**（仅在以下情况介入）：
- 突发事件得分 < -0.3（重大负面）
- 风险等级 > 0.3（高风险环境）

**调整策略**：
```
紧急事件预警时：
  - 持有现金 → +0.3奖励
  - 卖出操作 → +0.5奖励
  - 买入操作 → -0.5惩罚
  - 加大卖出比例（×1.5）
  - 减少买入比例（×0.3）
```

### 4. 差异化风险策略（继承V7）

| 标的类型 | 最大仓位 | 风险阈值 | 回撤容忍 |
|---------|---------|---------|----------|
| 银行股 | 80% | 3.0 | 15% |
| 保险股 | 70% | 3.5 | 20% |
| 白酒股 | 60% | 4.0 | 25% |

---

## 🔧 技术实现

### 文件结构

```
RL-Stock/
├── stock_env_v9.py          # V9环境（主辅策略）
├── train_v9.py              # 训练脚本
├── evaluate_v9.py           # 评估脚本
├── llm_market_intelligence.py  # LLM代理（复用）
└── market_intelligence_cache/  # LLM数据缓存
```

### LLM集成方式

#### V8（失败）：LLM作为主要特征
```python
observation = [technical_indicators(21维) + llm_features(8维)]
llm_weight = 0.3  # 30%权重
```

#### V9（改进）：LLM作为辅助信号
```python
observation = [V7_features + llm_event_signal(3维)]
llm_weight = 0.05  # 5%权重
llm只在紧急事件时介入
```

---

## 🚀 使用指南

### 1. 训练

```bash
python train_v9.py
```

**训练配置**：
- 总步数：300万（与V7相同）
- 并行环境：8个
- 主策略：V7技术指标（95%）
- 辅助策略：LLM事件检测（5%）
- 训练时长：约20-30分钟

### 2. 评估

```bash
python evaluate_v9.py
```

**评估指标**：
- 平均收益率
- 最大回撤
- 夏普比率
- 交易次数
- 风险事件处理

### 3. 实盘部署（推荐）

V9的优势在于**实时事件处理**：

```python
# 实盘时每日调用LLM获取当日真实情报
today_intel = llm_agent.get_market_intelligence(today, use_cache=False)

# V9会根据真实事件调整交易策略
if today_intel['emergency_impact_score'] < -0.3:
    # 自动降低风险暴露
    model.predict(obs, deterministic=True)
```

---

## 📈 预期效果

### 目标

| 指标 | V7 | V9目标 |
|------|-----|--------|
| 平均收益率 | +10.57% | **≥10%** |
| 最大回撤 | ~10% | **<12%** |
| 夏普比率 | ~1.0 | **≥0.9** |
| 事件响应 | 无 | **有** ✅ |

### 优势

1. ✅ **继承V7稳定性**：技术指标策略成熟可靠
2. ✅ **增强风险感知**：LLM检测黑天鹅事件
3. ✅ **低成本**：LLM调用少（仅紧急时）
4. ✅ **实盘适用**：实时处理突发新闻/政策

### 适用场景

- 🌟 **日常交易**：V7技术指标主导
- 🚨 **突发事件**：LLM介入预警（如政策突变、黑天鹅）
- 📰 **新闻冲击**：实时调整风险暴露

---

## 🔬 实验对比

### 版本演进

| 版本 | 策略 | 收益率 | 问题 |
|------|------|--------|------|
| V4 | 基础RL | 0% | 不交易 |
| V5 | +风险感知 | ~28% | 训练数据过拟合 |
| V6 | +组合管理 | - | - |
| **V7** | **+差异化策略** | **+10.57%** 🏆 | **最佳** |
| V8 Mock | +LLM(模拟) | +8.49% | 略降 |
| V8 Real | +LLM(历史) | +5.98% | 失败 ❌ |
| **V9** | **V7+LLM(事件)** | **目标≥10%** | **最优组合** ⭐ |

### 关键洞察

**为什么V8失败，V9可能成功？**

| 维度 | V8 Real | V9 |
|------|---------|-----|
| **LLM数据** | 历史"猜测" ❌ | 实时事件 ✅ |
| **LLM权重** | 30%（主要） | 5%（辅助） |
| **策略主导** | LLM | V7技术指标 |
| **适用场景** | 回测 | 实盘 |
| **数据质量** | 虚构 | 真实 |

---

## 💡 使用建议

### 回测阶段（当前）

使用**缓存的LLM数据**进行训练：
- 成本低（已生成）
- 验证策略有效性
- 调优参数

### 实盘阶段（推荐）

每日获取**真实LLM情报**：
```python
# 实盘代码示例
import datetime

today = datetime.date.today().strftime('%Y-%m-%d')
intel = llm_agent.get_market_intelligence(
    date=today,
    use_cache=False,  # 不使用缓存，调用真实API
    real_time=True
)
```

---

## 📝 总结

V9采用**主辅策略结合**的设计理念：

1. **主策略**：V7的技术指标 + 风险管理（95%权重）
   - 稳定可靠
   - 历史验证有效

2. **辅助策略**：LLM事件检测（5%权重）
   - 仅在紧急时介入
   - 处理黑天鹅事件
   - 实盘价值最大

**预期**：V9将保持V7的稳定收益（~10%），同时增强对突发事件的响应能力。

---

## 🚀 开始使用

```bash
# 1. 训练V9模型
python train_v9.py

# 2. 评估效果
python evaluate_v9.py

# 3. 对比V7/V8/V9
# 查看results_v*.csv文件
```

**期待V9成为生产环境的最佳选择！** 🎯

